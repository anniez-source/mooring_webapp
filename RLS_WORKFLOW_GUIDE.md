# üîí Row Level Security (RLS) Workflow Guide

## How Data Access Works Now

With RLS enabled, every database query is automatically filtered based on the **logged-in user's JWT token**. Here's what happens for each table:

---

## üìã Table-by-Table Workflow

### 1. **USERS** Table

**What users can see:**
```javascript
// User queries:
const { data } = await supabase.from('users').select('*');

// RLS automatically filters to:
// "Show me all users who belong to the same organizations as me"
```

**Workflow:**
- ‚úÖ **SELECT**: Can view all users in their organization(s)
- ‚úÖ **INSERT**: Can create their own user record (on signup)
- ‚úÖ **UPDATE**: Can update their own record only
- ‚ùå **DELETE**: Not allowed

**Example:**
```
User A (Test Environment) queries users
‚Üí Sees: All Test Environment members
‚Üí Doesn't see: Nexus Maine members

User B (Nexus Maine + Test Environment) queries users  
‚Üí Sees: All Nexus Maine members + All Test Environment members
‚Üí Combined view across both orgs
```

---

### 2. **PROFILES** Table

**What users can see:**
```javascript
// User queries:
const { data } = await supabase.from('profiles').select('*');

// RLS filters to:
// "Show me my own profile + opted-in profiles from my organizations"
```

**Workflow:**
- ‚úÖ **SELECT**: Can view their own profile + opted-in profiles from their organization(s)
- ‚úÖ **INSERT**: Can create their own profile (onboarding)
- ‚úÖ **UPDATE**: Can update their own profile only
- ‚ùå **DELETE**: Not allowed

**Example:**
```
User A searches for a technical cofounder
‚Üí AI receives: All opted-in profiles from User A's organizations
‚Üí AI matches: Only shows relevant people from same org(s)
‚Üí User A sees: Name, background, expertise, looking_for, open_to
‚Üí User A CANNOT see: Non-opted-in profiles (database enforced!)
‚Üí User A CANNOT see: Profiles from other organizations

User B (opted_in = false) queries profiles
‚Üí Sees: Only their own profile
‚Üí Doesn't see: Any other profiles (not visible for matching)
```

**Privacy Note:** 
- ‚úÖ **Opted-in users**: Visible to others in same org (needed for AI matching)
- ‚ùå **Opted-out users**: Hidden from everyone except themselves
- ‚úÖ **Own profile**: Always visible to yourself (for profile page)

---

### 3. **ORGANIZATIONS** Table

**What users can see:**
```javascript
// User queries:
const { data } = await supabase.from('organizations').select('*');

// RLS filters to:
// "Show me only organizations I'm a member of"
```

**Workflow:**
- ‚úÖ **SELECT**: Can view organizations they belong to
- ‚ùå **INSERT/UPDATE/DELETE**: Not allowed (admin-only via SQL)

**Example:**
```
User A (Test Environment member)
‚Üí Queries organizations
‚Üí Sees: { name: "Test Environment", org_id: "..." }
‚Üí Doesn't see: Nexus Maine or any other orgs

User B (member of both orgs)
‚Üí Sees: Both Test Environment AND Nexus Maine
```

---

### 4. **ORGANIZATION_MEMBERS** Table

**What users can see:**
```javascript
// User queries:
const { data } = await supabase.from('organization_members').select('*');

// RLS filters to:
// "Show me all members of my organizations"
```

**Workflow:**
- ‚úÖ **SELECT**: Can view all members of their organization(s)
- ‚úÖ **INSERT**: Can add themselves to an org (if they have an invite - future feature)
- ‚ùå **UPDATE/DELETE**: Not allowed

**Example:**
```
User A wants to see who else is in Test Environment
‚Üí Queries organization_members
‚Üí Sees: All user_id's + roles in Test Environment
‚Üí Can join with users table to get names/emails
```

---

### 5. **CHAT_SESSIONS** Table

**What users can see:**
```javascript
// User queries:
const { data } = await supabase.from('chat_sessions').select('*');

// RLS filters to:
// "Show me ONLY my own chat sessions"
```

**Workflow:**
- ‚úÖ **SELECT**: Can view their own chat sessions only
- ‚úÖ **INSERT**: Can create new chat sessions
- ‚úÖ **UPDATE**: Can update their own sessions (e.g., update `last_message_at`)
- ‚ùå **DELETE**: Not allowed

**Example:**
```
User A has 3 chat sessions:
- "Looking for technical cofounder" (session_1)
- "Need marketing advice" (session_2)
- "Seeking introductions" (session_3)

User A queries chat_sessions
‚Üí Sees: All 3 of their own sessions
‚Üí Doesn't see: Any other user's sessions

User B queries chat_sessions
‚Üí Sees: Only their own sessions
‚Üí CANNOT see User A's sessions (privacy protected!)
```

**Privacy:** ‚úÖ **Complete isolation - no one can see your conversations**

---

### 6. **CHAT_MESSAGES** Table

**What users can see:**
```javascript
// User queries:
const { data } = await supabase
  .from('chat_messages')
  .select('*')
  .eq('chat_session_id', 'some_session_id');

// RLS filters to:
// "Show me messages ONLY from my own chat sessions"
```

**Workflow:**
- ‚úÖ **SELECT**: Can view messages from their own sessions only
- ‚úÖ **INSERT**: Can add messages to their own sessions
- ‚ùå **UPDATE/DELETE**: Not allowed (preserve message history)

**Example:**
```
User A tries to read messages from session_1 (their own)
‚Üí ‚úÖ Success: Returns all messages from that session

User A tries to read messages from session_999 (belongs to User B)
‚Üí ‚ùå Returns empty array (RLS blocks access)

User B tries to query all messages
‚Üí Only sees messages from their own sessions
‚Üí Cannot see User A's messages
```

**Privacy:** ‚úÖ **Strongest protection - messages are completely private**

---

### 7. **SAVED_CONTACTS** Table

**What users can see:**
```javascript
// User queries:
const { data } = await supabase.from('saved_contacts').select('*');

// RLS filters to:
// "Show me ONLY contacts that I saved"
```

**Workflow:**
- ‚úÖ **SELECT**: Can view their own saved contacts only
- ‚úÖ **INSERT**: Can save new contacts
- ‚úÖ **UPDATE**: Can update their own saves (for click tracking)
- ‚úÖ **DELETE**: Can delete their own saved contacts

**Example:**
```
User A saves 5 profiles to their saved contacts
User B saves 3 profiles to their saved contacts

User A queries saved_contacts
‚Üí Sees: Their 5 saved contacts
‚Üí Doesn't see: User B's 3 saved contacts

User A clicks email button on saved contact
‚Üí Updates email_clicked = true
‚Üí Only on their own saved contact record

User A deletes a saved contact
‚Üí Removes from their saved_contacts
‚Üí Doesn't affect the actual profile
‚Üí Other users' saves are unaffected
```

**Privacy:** ‚úÖ **Saved contacts are completely private to each user**

---

### 8. **COMMUNITY_THEMES** Table (if exists)

**What users can see:**
```javascript
// User queries:
const { data } = await supabase.from('community_themes').select('*');

// RLS filters to:
// "Show me themes generated for my organizations"
```

**Workflow:**
- ‚úÖ **SELECT**: Can view themes from their organization(s)
- ‚ùå **INSERT/UPDATE/DELETE**: Only via API routes (admin functionality)

**Example:**
```
Admin generates community themes for Test Environment
‚Üí Stores: { org_id: test_env_id, themes: {...}, generated_at: ... }

User A (Test Environment) views analytics page
‚Üí Sees: Themes for Test Environment

User B (Nexus Maine) views analytics page
‚Üí Sees: Themes for Nexus Maine
‚Üí Doesn't see: Test Environment themes
```

---

## üîÑ Real-World User Journeys

### Journey 1: New User Signs Up

```
1. User signs up with Clerk
   ‚úÖ Creates record in users table (RLS allows: clerk_user_id = their JWT)

2. Trigger auto-assigns to Test Environment
   ‚úÖ Creates record in organization_members
   
3. User completes onboarding
   ‚úÖ Creates record in profiles table (RLS allows: user_id = their user_id)
   
4. User is now visible to others in Test Environment for matching
```

---

### Journey 2: User Searches for Matches

```
1. User sends message: "I need a technical cofounder"

2. API fetches profiles:
   const { data } = await supabase.from('profiles').select('*');
   
   RLS automatically filters to:
   - ‚úÖ Users in Test Environment
   - ‚úÖ opted_in = true
   - ‚ùå Excludes other organizations
   - ‚ùå Excludes their own profile

3. API creates chat_session:
   - user_id: current_user
   - org_id: test_environment_id
   - RLS allows: user_id matches JWT

4. API stores user message:
   - chat_session_id: session_1
   - role: 'user'
   - RLS allows: session belongs to current user

5. Claude processes and responds

6. API stores assistant message:
   - Same session
   - role: 'assistant'
   - RLS allows: session belongs to current user
```

---

### Journey 3: User Saves a Contact

```
1. User clicks heart button on matched profile

2. Frontend calls /api/save-collaborator:
   {
     saved_profile_id: "profile_123",
     chat_session_id: "session_1",
     reason: "Great technical background..."
   }

3. API inserts into saved_contacts:
   RLS checks:
   - ‚úÖ user_id matches current user's JWT
   - ‚úÖ Insert allowed
   
4. User navigates to /saved page

5. Frontend queries saved_contacts:
   const { data } = await supabase.from('saved_contacts').select('*');
   
   RLS filters:
   - ‚úÖ Only returns current user's saved contacts
   - ‚ùå Other users' saves are invisible

6. User clicks email button

7. API updates saved_contacts:
   UPDATE saved_contacts SET email_clicked = true
   WHERE user_id = current_user AND saved_profile_id = "profile_123"
   
   RLS allows:
   - ‚úÖ Update their own record only
```

---

### Journey 4: User Tries to Access Other User's Data (Attack Attempt)

```
1. Malicious user opens browser console

2. Tries to query all profiles:
   const { data } = await supabase.from('profiles').select('*');
   
   RLS filters:
   - ‚úÖ Only returns profiles from their own organization
   - ‚ùå Cannot see profiles from other orgs

3. Tries to query other user's messages:
   const { data } = await supabase
     .from('chat_messages')
     .select('*')
     .eq('chat_session_id', 'someone_else_session');
   
   RLS blocks:
   - ‚ùå Returns empty array (session doesn't belong to them)

4. Tries to read someone else's saved contacts:
   const { data } = await supabase.from('saved_contacts').select('*');
   
   RLS filters:
   - ‚úÖ Only returns their own saved contacts
   - ‚ùå Cannot see other users' saves

RESULT: ‚úÖ Attack fails - RLS protects all data
```

---

## üìä Privacy Summary

| Data Type | Who Can See It | Privacy Level |
|-----------|----------------|---------------|
| **User records** | Same org members | üü° Shared within org |
| **Profiles (opted-in)** | Same org members | üü° Shared within org |
| **Profiles (opted-out)** | Owner only | üü¢ Completely private |
| **Own profile** | Always visible to self | üü¢ Always accessible |
| **Chat sessions** | Owner only | üü¢ Completely private |
| **Chat messages** | Owner only | üü¢ Completely private |
| **Saved contacts** | Owner only | üü¢ Completely private |
| **Organizations** | Members only | üü° Shared with members |
| **Org members** | Same org members | üü° Shared within org |
| **Community themes** | Same org members | üü° Shared within org |

---

## üéØ Key Takeaways

1. **Organization Isolation:**
   - Users from Test Environment cannot see Nexus Maine data
   - Multi-org users see combined view across their orgs

2. **Conversation Privacy:**
   - Chat sessions and messages are **100% private**
   - No one can read your conversations

3. **Saved Contacts Privacy:**
   - Your saved contacts are **completely private**
   - Saved contact's profile can still see other people from their org
   - But they can't see who saved them

4. **Profile Visibility:**
   - Profiles are visible within the same organization
   - This is **intentional** for AI matching to work
   - Only opted-in profiles are shown

5. **Automatic Filtering:**
   - You don't need to add `.eq('user_id', current_user)` to queries
   - RLS handles it automatically
   - Queries fail safely if you try to access unauthorized data

---

## üîç How to Verify RLS is Working

### Test 1: Profile Isolation
```javascript
// In browser console
const { data } = await supabase.from('profiles').select('*');
console.log(data.length); // Should only be profiles from your org(s)
```

### Test 2: Chat Privacy
```javascript
// In browser console
const { data } = await supabase.from('chat_sessions').select('*');
console.log(data); // Should only show YOUR sessions

const { data: messages } = await supabase.from('chat_messages').select('*');
console.log(messages); // Should only show YOUR messages
```

### Test 3: Saved Contacts Privacy
```javascript
// In browser console
const { data } = await supabase.from('saved_contacts').select('*');
console.log(data); // Should only show YOUR saved contacts
```

### Test 4: Organization Filtering
```javascript
// Create test users in different orgs
// Log in as User A (Test Environment)
// Try to query User B's profile (Nexus Maine)
const { data } = await supabase
  .from('profiles')
  .select('*')
  .eq('email', 'userB@nexusmaine.org');
  
console.log(data); // Should return empty array (different org)
```

---

## ‚úÖ Summary

**Before RLS:** Anyone could query any table and see all data  
**After RLS:** Users only see data from their organization(s), and private data is completely isolated

**Your app is now secure! üîí**

